version: "3.9"

services:
  # Override existing NeuroSync service to launch BOTH core API & BYOC worker
  neurosync:
    build:
      context: .
      dockerfile: ./NeuroSync-Core/dockerfile
    container_name: neurosync_s1  # keep same name so Eliza keeps working
    mem_limit: 12g # Add memory limit
    entrypoint: ["/app/combined_entrypoint.sh"] # Ensure combined entrypoint for full functionality
    environment:
      - SERVER_PORT=9876
      - ORCH_URL=https://orchestrator:9995
      - ORCH_SECRET=orch-secret
      - CAPABILITY_NAME=start-echo-test
      - CAPABILITY_DESCRIPTION=simple text echo capability
      - CAPABILITY_URL=http://neurosync:9876
      - CAPABILITY_PRICE_PER_UNIT=1
      - CAPABILITY_PRICE_SCALING=1
      - CAPABILITY_CAPACITY=1
    networks:
      - scb_bridge_net  # original network for Eliza bridge
      - byoc            # new network for orchestrator/gateway
    deploy: # Add deploy configuration for GPU access
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1 # or 'all'
              capabilities: [gpu]
    depends_on:
      - orchestrator
    env_file:
      - ./env_files/.neurosync.env
    volumes: []

  # === Orchestrator ===
  orchestrator:
    image: adastravideo/go-livepeer:dynamic-capabilities-2
    container_name: byoc-orchestrator
    volumes:
      - ./data/orchestrator:/data
    ports:
      - 9995:9995
    command: ["-orchestrator",
          "-orchSecret=orch-secret",
          "-serviceAddr=0.0.0.0:9995",
          "-v=6",
          "-network=arbitrum-one-mainnet",
          "-ethUrl=https://arb1.arbitrum.io/rpc",
          "-ethPassword=<your eth pass here>",
          "-dataDir=/data",
          "-ethOrchAddr=<your orch address here>",
          "-pricePerUnit=1"]
    networks:
      - byoc

  # === Gateway (optional for on-chain) ===
  gateway:
    image: adastravideo/go-livepeer:dynamic-capabilities-2
    container_name: byoc-gateway
    command: ["-gateway", "-orchAddr=https://orchestrator:9995", "-httpAddr=0.0.0.0:9999", "-network=offchain"]
    ports:
      - "9999:9999"
    volumes:
      - ./data/gateway:/data
    networks:
      - byoc

  # === Caddy ===
  caddy:
    image: caddy:latest
    container_name: byoc-caddy
    volumes:
      - ./webapp/Caddyfile:/etc/caddy/Caddyfile
      - ./webapp/dist:/var/www/html/app
    ports:
      - "8088:8088"
    networks:
      - byoc

networks:
  byoc:
    driver: bridge 